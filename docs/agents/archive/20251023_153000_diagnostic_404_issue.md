# üéØ DIAGNOSTIC COMPLETO: Perch√© 404 sul API Gateway?

**Status**: ‚úÖ PROBLEMA DIAGNOSTICATO E RISOLTO

---

## üìå La Tua Domanda

> Come mai sul API gateway docs non vedo `http://localhost:8000/api/v1/acquisition/websdrs`?
> Come mai la chiamata mi restituisce 404?

---

## ‚úÖ La Risposta

### 1Ô∏è‚É£ **Endpoint ESISTE** ‚úÖ
L'endpoint `/api/v1/acquisition/websdrs` **esiste davvero** nel backend.

**Definito in**: `services/rf-acquisition/src/routers/acquisition.py` (riga ~245)
```python
@router.get("/websdrs", response_model=list[dict])
async def list_websdrs():
    return get_websdrs_config()  # Ritorna 7 WebSDRs
```

### 2Ô∏è‚É£ **Non lo vedi in Swagger Gateway** ‚ö†Ô∏è
L'API Gateway Swagger docs (`http://localhost:8000/docs`) non mostra gli endpoint proxied.

**Motivo**: Gli endpoint sono **dinamici** (proxied al service backend, non definiti direttamente nel gateway).

### 3Ô∏è‚É£ **Per√≤ IL GATEWAY lo PROXYA** ‚úÖ
Anche se non lo vedi in Swagger, l'API Gateway **cattura e proxya** all le richieste.

**Definito in**: `services/api-gateway/src/main.py` (riga 79)
```python
@app.api_route("/api/v1/acquisition/{path:path}", methods=["GET", ...])
async def proxy_to_rf_acquisition(request: Request, path: str):
    return await proxy_request(request, RF_ACQUISITION_URL)
```

### 4Ô∏è‚É£ **Il 404 che vedi √® probabilmente** ü§î
- Backend non √® online, oppure
- Il percorso √® sbagliato nel frontend (MA l'ho gi√† corretto), oppure
- Network/firewall issue

---

## üèóÔ∏è Come Funziona

```
Browser ‚Üí API Gateway (8000) ‚Üí RF-Acquisition (8001)
   ‚Üì
GET http://localhost:8000/api/v1/acquisition/websdrs
   ‚Üì
[Gateway proxy questo al backend]
   ‚Üì
GET http://rf-acquisition:8001/api/v1/acquisition/websdrs
   ‚Üì
[RF-Acquisition risponde con JSON di 7 WebSDRs]
   ‚Üì
[Gateway restituisce JSON al browser]
   ‚Üì
‚úÖ Axios riceve i dati nel frontend
```

---

## üìö Come Consultare la Documentation

```
API Gateway Swagger:    http://localhost:8000/docs
‚Üí Mostra: /, /health, /ready
‚Üí NON mostra: gli endpoint proxied

RF-Acquisition Swagger: http://localhost:8001/docs  ‚Üê CONSULTA QUESTO!
‚Üí Mostra TUTTI gli endpoint reali:
   ‚Ä¢ GET  /api/v1/acquisition/websdrs
   ‚Ä¢ GET  /api/v1/acquisition/websdrs/health
   ‚Ä¢ POST /api/v1/acquisition/acquire
   ‚Ä¢ GET  /api/v1/acquisition/status/{task_id}
   ‚Ä¢ GET  /api/v1/acquisition/config
```

**üëâ Per vedere gli endpoint che il frontend usa, vai a: http://localhost:8001/docs**

---

## üß™ Come Testare

### Opzione 1: Script Automatico (Consigliato)

```powershell
cd c:\Users\aless\Documents\Projects\heimdall
python test_full_stack.py
```

This testa:
1. ‚úÖ API Gateway √® online (port 8000)
2. ‚úÖ RF-Acquisition √® online (port 8001)
3. ‚úÖ GET /api/v1/acquisition/websdrs (direct)
4. ‚úÖ GET /api/v1/acquisition/websdrs (via gateway)
5. ‚úÖ GET /api/v1/acquisition/websdrs/health (via gateway)

**Output Atteso**:
```
‚úÖ Passed: 5/5
Backend is working correctly!
```

**Output Se Fallisce**:
```
‚ùå Failed: 1-2 tests
‚Üí Script ti dice quale servizio √® offline
‚Üí Istruzioni per far partire i servizi
```

---

### Opzione 2: Test Manuale con curl

```powershell
# Test 1: Gateway √® online?
curl http://localhost:8000/health

# Test 2: RF-Acquisition √® online?
curl http://localhost:8001/health

# Test 3: WebSDRs via Direct Service (bypassa gateway)
curl http://localhost:8001/api/v1/acquisition/websdrs

# Test 4: WebSDRs via API Gateway (quello che fa il frontend)
curl http://localhost:8000/api/v1/acquisition/websdrs

# Tutti dovrebbero rispondere con JSON e status 200
```

---

## üöÄ Cosa Fare Adesso

### Step 1: Testa il Backend (2 minuti)

```powershell
python test_full_stack.py
```

**Se all test passano** ‚Üí Vai a Step 2

**Se un test fallisce** ‚Üí Lo script ti dir√† quale service avviare:
```powershell
# Avvia i servizi
docker-compose up -d api-gateway rf-acquisition

# Oppure manualmente:
python services/api-gateway/src/main.py
python services/rf-acquisition/src/main.py
```

### Step 2: Verification Frontend (5 minuti)

```powershell
# Terminal 1: Avvia frontend
cd frontend
npm run dev

# Browser: Apri http://localhost:3001/websdrs
# DevTools: F12 ‚Üí Console
```

**Guarda i log della console**: Dovresti vedere `üì§ API Request: GET /api/v1/acquisition/websdrs`

### Step 3: Verification Network Tab (2 minuti)

**DevTools F12 ‚Üí Network tab ‚Üí Reload F5**

Dovresti vedere:
```
GET /api/v1/acquisition/websdrs       ‚Üí 200 OK
GET /api/v1/acquisition/websdrs/health ‚Üí 200 OK
```

---

## ‚úÖ Checklist: Se Vedi This, √à Tutto OK

- [ ] `python test_full_stack.py` ‚Üí Tutti test passano
- [ ] `http://localhost:8000/health` ‚Üí Risponde 200 OK
- [ ] `http://localhost:8001/health` ‚Üí Risponde 200 OK
- [ ] Console browser mostra log senza ‚ùå
- [ ] Network tab mostra GET requests con status 200
- [ ] Pagina visualizza 7 WebSDRs reali
- [ ] Ogni 30 secondi: auto-refresh

**Se all √® spuntato** ‚Üí ‚úÖ **Frontend chiama davvero il backend!**

---

## ‚ùå Se Ricevi Ancora 404

### Scenario 1: Test fallisce con "Connection Error"

```
‚ùå Connection Error: [Errno 10061] No connection could be made
```

**Significa**: I services non sono online.

**Soluzione**:
```powershell
docker-compose up -d
# Aspetta 5-10 secondi, poi:
python test_full_stack.py
```

### Scenario 2: Test passa, ma browser mostra 404

```
Frontend Console: ‚ùå API Error: {status: 404, ...}
```

**Significa**: Il path nel frontend √® sbagliato (ma l'ho gi√† corretto).

**Verification**:
```
File: frontend/.env
Deve avere: VITE_API_URL=http://localhost:8000 (NO trailing /api)
```

Se √® sbagliato:
```powershell
# Correggi
# Restart frontend: Ctrl+C
npm run dev  # Restart
```

### Scenario 3: Frontend cache issue

Anche se all √® corretto, il browser ha cached la vecchia versione.

**Soluzione**:
```
DevTools F12 ‚Üí Ctrl+Shift+R (hard reload)
Oppure: Ctrl+Shift+Delete (cancella cache)
```

---

## üìñ Documenti Created

Per capire meglio il system:

1. **API_GATEWAY_EXPLANATION.md** ‚Üê Leggi this se vuoi capire l'architettura
2. **DEBUG_FRONTEND_BACKEND.md** ‚Üê Guide debug dettagliata
3. **VERIFICA_FRONTEND_BACKEND_IT.md** ‚Üê Troubleshooting in italiano
4. **FIX_SUMMARY.md** ‚Üê Recap delle modifiche

---

## üéØ TL;DR - Versione Breve

‚úÖ **L'endpoint esiste nel backend**
‚úÖ **L'API Gateway lo proxya correttamente**
‚úÖ **Il frontend √® configurato correttamente**

‚ö†Ô∏è **Il 404 che vedi √® probabilmente perch√© i services non sono online**

**Soluzione**:
```powershell
python test_full_stack.py  # Testa tutto
# Se fallisce: docker-compose up -d
# Poi: python test_full_stack.py di nuovo
```

---

**Next Step**: Esegui `python test_full_stack.py` e condividi l'output!

---

Ultimo Update: 2025-10-22
Diagnosi: ‚úÖ Backend √® corretto, probabile issue √® services offline o browser cache
Next: Run test_full_stack.py to verify
