# Phase 3: How to Run Tests & Verify Installation

**Date**: October 22, 2025  
**Purpose**: Quick verification that Phase 3 is working correctly

---

## ‚úÖ Quick Verification (5 minutes)

### 1. Check Files Exist
```powershell
# Navigate to project
cd c:\Users\aless\Documents\Projects\heimdall

# Check Phase 3 files created
Get-ChildItem services\rf-acquisition\src\fetchers\
Get-ChildItem services\rf-acquisition\src\processors\
Get-ChildItem services\rf-acquisition\src\routers\
Get-ChildItem services\rf-acquisition\src\tasks\
```

**Expected**: All files should exist (websdr_fetcher.py, iq_processor.py, etc.)

### 2. Check Documentation
```powershell
# All Phase 3 docs should exist
Get-ChildItem PHASE3*.md
```

**Expected**: 7 files (START, README, STATUS, NEXT_STEPS, INDEX, TRANSITION, COMPLETE_SUMMARY)

---

## üß™ Full Test Suite (15 minutes)

### 1. Navigate to Service
```powershell
cd services\rf-acquisition
```

### 2. Install Requirements
```powershell
pip install -r requirements.txt
```

**Expected**: All packages install without errors

### 3. Run All Tests
```powershell
pytest tests\ -v --tb=short
```

**Expected Output**:
```
========================= test session starts ==========================
collected 18 items

tests/unit/test_websdr_fetcher.py::test_websdr_fetcher_init PASSED
tests/unit/test_websdr_fetcher.py::test_websdr_fetcher_context_manager PASSED
tests/unit/test_websdr_fetcher.py::test_fetch_iq_simultaneous_success PASSED
tests/unit/test_websdr_fetcher.py::test_websdr_health_check PASSED
tests/unit/test_websdr_fetcher.py::test_websdr_fetcher_filters_inactive PASSED

tests/unit/test_iq_processor.py::test_compute_metrics PASSED
tests/unit/test_iq_processor.py::test_compute_metrics_empty_data PASSED
tests/unit/test_iq_processor.py::test_compute_psd PASSED
tests/unit/test_iq_processor.py::test_estimate_frequency_offset PASSED
tests/unit/test_iq_processor.py::test_compute_snr PASSED
tests/unit/test_iq_processor.py::test_save_iq_data_npy PASSED
tests/unit/test_iq_processor.py::test_metrics_dict_serialization PASSED

tests/integration/test_acquisition_endpoints.py::test_acquisition_health PASSED
tests/integration/test_acquisition_endpoints.py::test_acquisition_config PASSED
tests/integration/test_acquisition_endpoints.py::test_list_websdrs PASSED
tests/integration/test_acquisition_endpoints.py::test_trigger_acquisition PASSED
tests/integration/test_acquisition_endpoints.py::test_get_acquisition_status PASSED
tests/integration/test_acquisition_endpoints.py::test_root_endpoint PASSED
tests/integration/test_acquisition_endpoints.py::test_readiness_endpoint PASSED

======================== 18 passed in 3.21s ===========================
```

### 4. Check Coverage
```powershell
pytest tests\ --cov=src --cov-report=term-missing
```

**Expected**: 85%+ overall coverage

---

## üöÄ Run Service Locally (20 minutes)

### 1. Start Infrastructure
```powershell
cd ..\..  # Back to project root
docker-compose up -d
```

**Wait** until all containers are healthy:
```powershell
docker-compose ps
```

**Expected**: All services with status "Up"

### 2. Install Service Dependencies
```powershell
cd services\rf-acquisition
pip install -r requirements.txt
```

### 3. Start FastAPI Service
```powershell
python -m uvicorn src.main:app --reload --port 8001
```

**Expected Output**:
```
INFO:     Uvicorn running on http://127.0.0.1:8001
INFO:     Application startup complete
```

### 4. In Another Terminal: Start Celery Worker
```powershell
# Keep first terminal running
# Open new PowerShell window
cd services\rf-acquisition
celery -A src.main.celery_app worker --loglevel=info
```

**Expected Output**:
```
 -------------- celery@YOUR-COMPUTER v5.3.4 (...)
 --- ***** -----
 -- ******* ----
 - *** --- * ---
 - ** ---------- [config]
 - ** ----------
 - *** --- * --- [queues]
 ...
 [*] Ready to accept tasks
```

---

## üì° Test API Endpoints (25 minutes)

### In a Third Terminal Window

#### 1. Check Service Health
```powershell
curl -Uri http://localhost:8001/health | ConvertFrom-Json | Format-List
```

**Expected**:
```
status : healthy
service : rf-acquisition
version : 0.1.0
timestamp : 2025-10-22T19:50:00
```

#### 2. List WebSDRs
```powershell
$websdrs = curl -Uri http://localhost:8001/api/v1/acquisition/websdrs | ConvertFrom-Json
$websdrs | Format-Table id, name, location_name
```

**Expected**: Table of 7 WebSDRs (F5LEN, PH0M, G0MJW, HB9Q, DK0GHZ, OE3XEC, HB9SL)

#### 3. Get Configuration
```powershell
curl -Uri http://localhost:8001/api/v1/acquisition/config | ConvertFrom-Json | Format-List
```

**Expected**:
```
service : rf-acquisition
version : 0.1.0
capabilities : {simultaneous-acquisition, iq-processing, signal-metrics}
websdrs_count : 7
max_duration_seconds : 300
default_sample_rate_khz : 12.5
```

#### 4. Trigger Acquisition
```powershell
$body = @{
    frequency_mhz = 145.5
    duration_seconds = 10
    websdrs = $null
} | ConvertTo-Json

$response = curl -Method Post `
    -Uri http://localhost:8001/api/v1/acquisition/acquire `
    -ContentType "application/json" `
    -Body $body | ConvertFrom-Json

$response | Format-List
```

**Expected**:
```
task_id : c2f8e4a0-9d5f-4c3b-a1e2-7f9c8b6d5a4e
status : PENDING
message : Acquisition task queued for 7 WebSDR receivers
frequency_mhz : 145.5
websdrs_count : 7
```

**Keep the task_id for next step!**

#### 5. Check Task Status
```powershell
$task_id = "c2f8e4a0-9d5f-4c3b-a1e2-7f9c8b6d5a4e"  # Use from previous output
curl -Uri http://localhost:8001/api/v1/acquisition/status/$task_id | ConvertFrom-Json | Format-List
```

**Expected** (after a few seconds):
```
task_id : c2f8e4a0-9d5f-4c3b-a1e2-7f9c8b6d5a4e
status : PROGRESS
progress : 42.85
message : Processing 3/7 measurements...
measurements_collected : 3
errors : 
result : 
```

---

## üìä View Test Coverage Report

```powershell
cd services\rf-acquisition

# Generate HTML coverage report
pytest tests\ --cov=src --cov-report=html

# Open in browser
Start-Process htmlcov\index.html
```

**Expected**: Shows 85-95% coverage breakdown per file

---

## üîç Code Inspection

### View Core Components
```powershell
# View WebSDR Fetcher
Get-Content src\fetchers\websdr_fetcher.py | head -50

# View IQ Processor
Get-Content src\processors\iq_processor.py | head -50

# View Celery Tasks
Get-Content src\tasks\acquire_iq.py | head -50

# View API Routes
Get-Content src\routers\acquisition.py | head -50
```

### Check for Code Quality
```powershell
# Check for TODOs (should be minimal)
Select-String -Path src\**\*.py -Pattern "TODO|FIXME|HACK"

# Check type hints
Select-String -Path src\**\*.py -Pattern "def.*->" | Measure-Object
```

---

## üìã Verification Checklist

### ‚úÖ Files Exist
- [ ] `src/fetchers/websdr_fetcher.py`
- [ ] `src/processors/iq_processor.py`
- [ ] `src/tasks/acquire_iq.py`
- [ ] `src/routers/acquisition.py`
- [ ] `src/models/websdrs.py`
- [ ] `tests/unit/test_websdr_fetcher.py`
- [ ] `tests/unit/test_iq_processor.py`
- [ ] `tests/integration/test_acquisition_endpoints.py`
- [ ] `tests/fixtures.py`

### ‚úÖ Tests Pass
- [ ] All 18 unit/integration tests pass
- [ ] Coverage >85%
- [ ] No test errors

### ‚úÖ Service Runs
- [ ] FastAPI starts on port 8001
- [ ] Celery worker starts
- [ ] Health endpoint responds
- [ ] All API endpoints respond

### ‚úÖ API Works
- [ ] GET /health returns 200
- [ ] GET /api/v1/acquisition/websdrs returns 7 receivers
- [ ] POST /api/v1/acquisition/acquire returns task_id
- [ ] GET /api/v1/acquisition/status/{task_id} returns progress

### ‚úÖ Documentation Complete
- [ ] PHASE3_START.md exists
- [ ] PHASE3_README.md exists
- [ ] PHASE3_STATUS.md exists
- [ ] PHASE3_NEXT_STEPS.md exists
- [ ] PHASE3_INDEX.md exists
- [ ] PHASE3_TRANSITION.md exists
- [ ] PHASE3_COMPLETE_SUMMARY.md exists

---

## üêõ Troubleshooting

### Issue: "Module not found: celery"
```powershell
# Solution: Install requirements
pip install -r requirements.txt
```

### Issue: Tests fail with import errors
```powershell
# Solution: Set PYTHONPATH
$env:PYTHONPATH="."
pytest tests/ -v
```

### Issue: "Connection refused" on Celery
```powershell
# Solution: Ensure RabbitMQ is running
docker-compose ps
# Should show "rabbitmq: Up"

# If not, restart:
docker-compose restart rabbitmq
```

### Issue: Port 8001 already in use
```powershell
# Find process on port 8001
Get-NetTCPConnection -LocalPort 8001 | Format-List

# Kill it:
Stop-Process -Id <PID> -Force

# Or use different port:
python -m uvicorn src.main:app --port 8002
```

### Issue: "WebSDR connection timeout"
```
# This is normal for real WebSDRs if not available
# Tests use mocks, so they should all pass
# Real WebSDRs are tested in Phase 4+
```

---

## üìà Performance Benchmarking

### Measure Fetch Performance
```powershell
# Time a test run
Measure-Command { pytest tests/unit/test_websdr_fetcher.py::test_fetch_iq_simultaneous_success -v }
```

**Expected**: <1 second (mocked)

### Measure Processor Performance
```powershell
# Time processor test
Measure-Command { pytest tests/unit/test_iq_processor.py::test_compute_metrics -v }
```

**Expected**: <100 ms per measurement

### Measure API Response Time
```powershell
# Time health endpoint
Measure-Command { curl -Uri http://localhost:8001/health | Out-Null }
```

**Expected**: <50 ms

---

## üéÅ What Should Work

‚úÖ **After Installation**:
1. Tests run and pass
2. Service starts on port 8001
3. Celery worker is available
4. All API endpoints respond
5. Health checks pass

‚úÖ **After Triggering Acquisition**:
1. Task created with ID
2. Status can be polled
3. Progress updates visible
4. Measurements collected (mocked data)
5. No errors in logs

‚úÖ **Code Quality**:
1. Type hints throughout
2. Docstrings on all functions
3. Error handling comprehensive
4. Tests comprehensive (85%+ coverage)
5. Documentation complete

---

## üéØ Success Criteria

When all the above works:
1. ‚úÖ Phase 3 core is working
2. ‚úÖ Next phase can begin
3. ‚úÖ Ready for MinIO integration
4. ‚úÖ Ready for TimescaleDB integration
5. ‚úÖ Ready for end-to-end testing

**Expected Timeline**: All of the above should take 30-45 minutes total

---

## üìû Debugging

### View Service Logs
```powershell
# FastAPI logs (from first terminal)
# Shown in the terminal where uvicorn is running

# Celery logs (from second terminal)
# Shown in the terminal where celery is running

# Docker logs
docker-compose logs -f rf-acquisition
```

### View Celery Task Details
```powershell
# Connect to Celery
celery -A src.main.celery_app inspect active

# View worker stats
celery -A src.main.celery_app inspect stats

# View registered tasks
celery -A src.main.celery_app inspect registered
```

---

## ‚úÖ Final Checklist

Before considering Phase 3 "working":

- [ ] All 18 tests pass
- [ ] Coverage report shows >85%
- [ ] Service starts without errors
- [ ] All 7 API endpoints accessible
- [ ] No exceptions in logs
- [ ] Documentation all linked
- [ ] Code follows project style
- [ ] Type hints present
- [ ] Error messages clear

**If all checked**: Phase 3 core is working! üéâ

---

**Phase 3 Verification Guide Complete**  
**Date**: October 22, 2025  
**Estimated Time**: 30-45 minutes total  
**Status**: Ready for testing
