# 🚀 PHASE 5: Training Pipeline - START HERE

**Status**: 🟢 READY TO LAUNCH  
**Date**: 2025-10-22 08:30:00 UTC  
**Duration**: 3 days (2025-10-22 to 2025-10-25)  
**Assignee**: Agent-ML (fulgidus)  
**Depends On**: ✅ Phase 1, ✅ Phase 3, ✅ Phase 4  
**Blocks**: Phase 6 (Inference Service)

---

## 📋 Welcome to Phase 5!

Benvenuto! Hai completato con successo **Phase 4: Infrastructure Validation** e l'intera architettura è **ready per il training pipeline**.

### ✅ Cosa è Stato Completato

**Phase 4 Summary**:
- ✅ Tutti i 13 container Docker healthy
- ✅ PostgreSQL + TimescaleDB operational
- ✅ RabbitMQ queue routing tasks
- ✅ MinIO buckets ready
- ✅ Redis caching functional
- ✅ E2E tests passing (87.5%)
- ✅ Performance baselines established (<52ms API latency)
- ✅ System stable under 50 concurrent tasks

### 🎯 Cosa Devi Fare (Phase 5)

Implementare **PyTorch Lightning Training Pipeline** con:
1. **Neural Network** per localizzazione radio
2. **Feature Extraction** da dati IQ
3. **PyTorch Dataset** per caricamento dati
4. **Training Loop** con Lightning
5. **MLflow** per tracking
6. **ONNX Export** per Phase 6 inference
7. **Comprehensive Tests** (>85% coverage)
8. **Complete Documentation**

### 📊 Infrastructure Già Disponibile

```
✅ PostgreSQL + TimescaleDB → Dati training
✅ MinIO S3 buckets → Salva IQ data e modelli
✅ MLflow → Tracking training runs
✅ Redis → Task results
✅ RabbitMQ → Task queue per Celery
✅ Python 3.11 + PyTorch/Lightning → Environment ready
```

---

## 🎬 Quick Start (5 minuti)

### Step 1: Leggi i Documenti
```bash
# Apri questi file (in ordine):
1. PHASE5_QUICK_START.md              # ← LEGGI QUESTO PRIMA
2. PHASE5_PROGRESS.md                 # Progress tracker
3. PHASE5_HANDOFF.md                  # Context dalla Phase 4
```

### Step 2: Verification Infrastructure
```bash
# Apri PowerShell e controlla:
cd c:\Users\aless\Documents\Projects\heimdall

docker-compose ps

# Dovresti vedere 13 container tutti "healthy"
# Se no, esegui:
docker-compose down
docker-compose up -d --build
```

### Step 3: Naviga al Service
```bash
cd services/training
ls src/
ls tests/
```

### Step 4: Installa Dependencies
```bash
pip install -r requirements.txt

# Verifica:
python -c "import torch; import pytorch_lightning; print('✅ Ready')"
```

### Step 5: Inizia T5.1
```bash
# Vedi PHASE5_QUICK_START.md, sezione "T5.1: Design Neural Network Architecture"
# Crea file: src/models/localization_net.py
```

---

## 📊 10 Tasks in 3 Giorni

| Task      | Descrizione                  | Effort | Day | Status |
| --------- | ---------------------------- | ------ | --- | ------ |
| **T5.1**  | Neural Network Architecture  | 2h     | 1   | 🔴      |
| **T5.2**  | Feature Extraction Utilities | 2h     | 1   | 🔴      |
| **T5.3**  | HeimdallDataset PyTorch      | 2h     | 1   | 🔴      |
| **T5.4**  | Gaussian NLL Loss            | 1.5h   | 1   | 🔴      |
| **T5.5**  | PyTorch Lightning Module     | 2h     | 2   | 🔴      |
| **T5.6**  | MLflow Tracking              | 1.5h   | 2   | 🔴      |
| **T5.7**  | ONNX Export                  | 1.5h   | 2   | 🔴      |
| **T5.8**  | Training Entry Point         | 2h     | 2   | 🔴      |
| **T5.9**  | Test Suite (>85%)            | 3h     | 3   | 🔴      |
| **T5.10** | Documentation                | 1h     | 3   | 🔴      |

**Total**: 18.5 hours di implementation + testing

---

## 🎯 Success Criteria

### Checkpoint CP5.1: Model Forward Pass ✓
```python
model = LocalizationNet()
x = torch.randn(4, 3, 128, 32)
output = model(x)
assert output.shape == (4, 4)  # [lat, lon, sigma_x, sigma_y]
```

### Checkpoint CP5.2: Dataset Loading ✓
```python
dataset = HeimdallDataset(db, minio)
sample = dataset[0]
assert sample['features'].shape == (128, 32)
```

### Checkpoint CP5.3: Training Loop ✓
```python
trainer = pl.Trainer(max_epochs=1)
trainer.fit(model, train_loader)
# No errors, loss decreases
```

### Checkpoint CP5.4: ONNX Export ✓
```bash
# Verify file exists in MinIO
aws s3 ls s3://heimdall-models/localization-v0.1.0.onnx --endpoint-url http://localhost:9000
# Should show the file
```

### Checkpoint CP5.5: MLflow Registration ✓
```bash
# Check MLflow UI
open http://localhost:5000
# Should show registered model with version
```

---

## 🧭 Architecture Overview

### Date Flow

```
┌─────────────────────────────────────────────────────────┐
│ Phase 3: RF Acquisition (WebSDR data)                  │
└──────────────────┬──────────────────────────────────────┘
                   │
                   ↓ (IQ data)
        ┌──────────────────────┐
        │ PostgreSQL Measurements
        │ MinIO Raw IQ buckets
        └──────────┬───────────┘
                   │
                   ↓ (Load data)
        ┌──────────────────────────────┐
        │ HeimdallDataset (T5.3)       │
        │ iq_to_mel_spectrogram (T5.2) │
        └──────────┬───────────────────┘
                   │
                   ↓ (Features: 128x32)
        ┌──────────────────────────────┐
        │ PyTorch DataLoader           │
        │ Batch: 32 samples            │
        └──────────┬───────────────────┘
                   │
                   ↓
        ┌──────────────────────────────┐
        │ LocalizationNet (T5.1)       │
        │ Input: mel-spectrogram       │
        │ Output: (lat, lon, σx, σy)  │
        └──────────┬───────────────────┘
                   │
                   ↓ (GaussianNLLLoss)
        ┌──────────────────────────────┐
        │ PyTorch Lightning (T5.5)     │
        │ Training Loop: 100 epochs    │
        └──────────┬───────────────────┘
                   │
                   ├─→ MLflow (T5.6) ─→ Model Registry
                   │
                   ↓ (Export)
        ┌──────────────────────────────┐
        │ ONNX (T5.7)                  │
        │ Upload to MinIO              │
        └──────────┬───────────────────┘
                   │
                   ↓
        ┌──────────────────────────────┐
        │ Ready for Phase 6: Inference │
        └──────────────────────────────┘
```

### Key Components

- **LocalizationNet** (T5.1): ResNet-18 CNN per localizzazione
- **Feature Extraction** (T5.2): Mel-spectrogram + normalization
- **HeimdallDataset** (T5.3): PyTorch Dataset da DB + MinIO
- **Gaussian NLL Loss** (T5.4): Penalizza overconfidence
- **Lightning Module** (T5.5): Training orchestration
- **MLflow Logger** (T5.6): Experiment tracking
- **ONNX Exporter** (T5.7): Model serialization per inference
- **Celery Task** (T5.8): Async training job
- **Test Suite** (T5.9): >85% coverage
- **Documentation** (T5.10): Architecture + usage

---

## 💡 Key Concepts

### 1. Uncertainty Estimation
Il modello predice **non solo la posizione, ma anche l'incertezza**:
```python
output = (lat, lon, sigma_x, sigma_y)
#        ────────────────────────────
#        Position    Uncertainty
```

This permette a Phase 6 (Inference) di mostrare **ellissi di confidenza** sulla mappa.

### 2. Gaussian NLL Loss
Perché? **MSE non penalizza incertezza eccessiva**:
```
MSE: L = (y - ŷ)²          ← Non conosce ŷ
Gaussian NLL: L = (y-μ)²/(2σ²) + log(σ)   ← Penalizza σ piccolo
```

### 3. PyTorch Lightning
Semplifica training con:
- Automatic backprop + gradient clipping
- Multi-GPU support (se disponibile)
- Automatic logging + checkpointing
- Early stopping

### 4. MLflow Registry
Traccia all i training runs:
```
Run #1: accuracy 78%, σ_loss 0.5
Run #2: accuracy 82%, σ_loss 0.3 ← Better
Run #3: accuracy 81%, σ_loss 0.4
# Seleziona Run #2 per production
```

### 5. ONNX Format
Modello serializzato **indipendente da PyTorch**:
```
PyTorch model (200 MB) ─→ ONNX (50 MB) ─→ Phase 6 inference
                          Fast
                          Portable
                          No Python required
```

---

## 🔧 Technical Stack (Phase 5)

| Component             | Version | Purpose                       |
| --------------------- | ------- | ----------------------------- |
| **PyTorch**           | 2.0+    | Neural network framework      |
| **PyTorch Lightning** | 2.0+    | Training orchestration        |
| **Scikit-learn**      | 1.3+    | Feature extraction (mel-spec) |
| **MLflow**            | 2.0+    | Experiment tracking           |
| **ONNX**              | 1.14+   | Model export                  |
| **psycopg2**          | 2.9+    | PostgreSQL driver             |
| **minio**             | 7.1+    | S3-compatible client          |
| **pytest**            | 7.4+    | Testing framework             |
| **numpy**             | 1.24+   | Numerical computing           |

---

## ⚠️ Potential Issues & Mitigations

| Issue                | Mitigation                              |
| -------------------- | --------------------------------------- |
| Nessun dato training | Generare dati sintetici                 |
| OOM (Out of Memory)  | Ridurre batch size da 32 a 16           |
| Modello non converge | Abbassare learning rate 1e-3 → 1e-4     |
| ONNX incompatibilità | Usare operazioni comuni, testare presto |
| MinIO upload lento   | Compress ONNX prima di upload           |

---

## 📞 Contacts & Resources

### Within Heimdall
- Phase 4 completion report: `PHASE4_COMPLETION_FINAL.md`
- Infrastructure setup: `SETUP.md`
- WebSDR configuration: `WEBSDRS.md`

### External Resources
- PyTorch Lightning: https://pytorch-lightning.readthedocs.io/
- MLflow Tracking: https://mlflow.org/docs/latest/tracking/
- ONNX Export: https://pytorch.org/docs/stable/onnx.html

---

## 📝 Next Actions

**Prossimi 5 minuti**:
1. ✅ Leggi PHASE5_QUICK_START.md completamente
2. ✅ Leggi PHASE5_HANDOFF.md per context
3. ✅ Verification Docker: `docker-compose ps`
4. ✅ Installa dependencies: `pip install -r requirements.txt`
5. ✅ Naviga a: `cd services/training`

**Prossimi 30 minuti**:
1. ⏳ Crea `src/models/localization_net.py` (T5.1)
2. ⏳ Testa con: `python -c "import src.models.localization_net"`

**Prossimi 3 days**:
1. ⏳ Completa T5.1-T5.10 in ordine
2. ⏳ Valida all 5 checkpoints
3. ⏳ Aggiorna PHASE5_PROGRESS.md ogni day

---

## ✨ Summary

**Phase 5 è il cuore del Heimdall**:
- Trasforma dati WebSDR grezzi in **modello di localizzazione intelligente**
- Stima **incertezza** per visualizzazione consapevole del rischio
- Esporta in **ONNX** per inference veloce (Phase 6)
- Registra in **MLflow** per reproducibility e versioning

**Tempo totale**: 18.5 hours di implementation  
**Complessità**: Media-Alta (ML fundamentals richiesti)  
**Impact**: Critico per funzionalità core del system

---

🚀 **Sei ready? Iniziamo con T5.1!**

**Path**: `services/training/src/models/localization_net.py`

---

**Last Updated**: 2025-10-22 08:30:00 UTC  
**Generated by**: GitHub Copilot (Phase 5 Coordinator)
