# üóÑÔ∏è Phase 1: Infrastructure & Database - Quick Start Guide

## Overview

Phase 1 sets up the complete infrastructure stack for Heimdall SDR using Docker Compose. This includes:

- **PostgreSQL 15** with TimescaleDB for time-series data
- **RabbitMQ 3.12** for async task processing
- **Redis 7** for caching and Celery backend
- **MinIO** for S3-compatible object storage
- **Prometheus + Grafana** for monitoring

## Prerequisites

- Docker Desktop installed and running
- Docker Compose v2.0+
- 8GB+ available RAM
- 20GB+ available disk space

## Quick Start

### 1. Setup Environment Variables

Copy the example environment file:

```bash
# PowerShell
copy .env.example .env

# Or manually
cp .env.example .env
```

Edit `.env` with your settings (credentials, ports, etc.).

### 2. Start Infrastructure

```bash
# Start all services in background
docker compose up -d

# Watch startup logs
docker compose logs -f

# Or use Makefile
make dev-up
```

The startup sequence is:
1. PostgreSQL starts and initializes schema
2. RabbitMQ starts
3. Redis starts
4. MinIO starts and creates buckets
5. Monitoring stack (Prometheus + Grafana) starts

**‚è±Ô∏è Expected startup time**: 30-60 seconds

### 3. Verify Health

```bash
# Check service status
make infra-status
# or
docker compose ps

# Run comprehensive health checks
make health-check

# Output should show:
# ‚úÖ PostgreSQL OK
# ‚úÖ RabbitMQ OK
# ‚úÖ Redis OK
# ‚úÖ MinIO OK
# ‚úÖ Prometheus OK
# ‚úÖ Grafana OK
```

### 4. Access Services

**Database & Management:**

```bash
# Connect to PostgreSQL CLI
make postgres-connect
# or
docker compose exec postgres psql -U heimdall_user -d heimdall

# Open pgAdmin
make pgadmin-ui
# URL: http://localhost:5050
# Email: admin@pg.com / Password: admin
```

**Message Queue & Cache:**

```bash
# RabbitMQ Management UI
make rabbitmq-ui
# URL: http://localhost:15672
# Username: guest / Password: guest

# Redis Commander
make redis-cli
# URL: http://localhost:8081
```

**Object Storage:**

```bash
# MinIO Console
make minio-ui
# URL: http://localhost:9001
# Username: minioadmin / Password: minioadmin

# Upload test file via AWS CLI
aws s3 cp test.txt s3://heimdall-raw-iq/ --endpoint-url http://localhost:9000
```

**Monitoring:**

```bash
# Prometheus
make prometheus-ui
# URL: http://localhost:9090

# Grafana
make grafana-ui
# URL: http://localhost:3000
# Username: admin / Password: admin
```

## Services & Ports

| Service         | Port  | UI  | Username      | Password   |
| --------------- | ----- | --- | ------------- | ---------- |
| PostgreSQL      | 5432  | -   | heimdall_user | changeme   |
| pgAdmin         | 5050  | ‚úÖ   | admin@pg.com  | admin      |
| RabbitMQ AMQP   | 5672  | -   | guest         | guest      |
| RabbitMQ UI     | 15672 | ‚úÖ   | guest         | guest      |
| Redis           | 6379  | -   | -             | changeme   |
| Redis Commander | 8081  | ‚úÖ   | -             | -          |
| MinIO API       | 9000  | -   | minioadmin    | minioadmin |
| MinIO Console   | 9001  | ‚úÖ   | minioadmin    | minioadmin |
| Prometheus      | 9090  | ‚úÖ   | -             | -          |
| Grafana         | 3000  | ‚úÖ   | admin         | admin      |

## Database Schema

The initialization script (`db/init-postgres.sql`) creates these tables:

```
heimdall schema
‚îú‚îÄ‚îÄ websdr_stations       # WebSDR receiver configuration
‚îú‚îÄ‚îÄ known_sources         # Radio sources for training
‚îú‚îÄ‚îÄ measurements          # IQ time-series (TimescaleDB hypertable)
‚îú‚îÄ‚îÄ recording_sessions    # Data collection sessions
‚îú‚îÄ‚îÄ training_datasets     # Training data collections
‚îú‚îÄ‚îÄ dataset_measurements  # M2M relationship
‚îú‚îÄ‚îÄ models                # ML model metadata
‚îî‚îÄ‚îÄ inference_requests    # API call tracking (TimescaleDB hypertable)
```

### Verify Schema Creation

```bash
# List all tables
docker compose exec postgres psql -U heimdall_user -d heimdall -c "\dt heimdall.*"

# List hypertables (TimescaleDB)
docker compose exec postgres psql -U heimdall_user -d heimdall -c \
  "SELECT * FROM timescaledb_information.hypertables;"

# Check indexes
docker compose exec postgres psql -U heimdall_user -d heimdall -c "\di heimdall.*"

# View table structure
docker compose exec postgres psql -U heimdall_user -d heimdall -c "\d heimdall.measurements"
```

## MinIO Buckets

The `minio-init` service automatically creates these buckets:

- `heimdall-raw-iq` - Raw IQ data from WebSDR
- `heimdall-models` - Trained ML models (ONNX format)
- `heimdall-mlflow` - MLflow artifacts and runs
- `heimdall-datasets` - Training datasets and preprocessing cache

### Upload/Download Test

```bash
# Using AWS CLI with MinIO endpoint
aws configure --profile minio
# Access Key: minioadmin
# Secret Key: minioadmin
# Region: us-east-1
# Output: json

# List buckets
aws s3 ls --endpoint-url http://localhost:9000 --profile minio

# Upload file
aws s3 cp test.txt s3://heimdall-raw-iq/test.txt --endpoint-url http://localhost:9000 --profile minio

# Download file
aws s3 cp s3://heimdall-raw-iq/test.txt downloaded.txt --endpoint-url http://localhost:9000 --profile minio
```

## Makefile Commands

```bash
# Lifecycle
make dev-up              # Start all services
make dev-down            # Stop all services
make dev-logs            # View logs from all services

# Status & Monitoring
make infra-status        # Show docker compose status
make health-check        # Run full health check script
make health-check-postgres
make health-check-rabbitmq
make health-check-redis
make health-check-minio

# CLI Access
make postgres-connect    # Connect to PostgreSQL
make redis-cli          # Connect to Redis
make rabbitmq-ui        # Open RabbitMQ UI
make minio-ui          # Open MinIO Console
make grafana-ui        # Open Grafana
make prometheus-ui     # Open Prometheus

# Cleanup
make clean              # Remove all containers and volumes
```

## Troubleshooting

### Containers not starting

```bash
# Check logs
docker compose logs postgres
docker compose logs rabbitmq

# Restart specific service
docker compose restart postgres

# Full reset (removes data!)
make clean
docker compose up -d
```

### Health check failures

```bash
# Individual service checks
make health-check-postgres
make health-check-rabbitmq
make health-check-redis

# Wait for services to stabilize (30-60 seconds)
# Then retry health-check
```

### Port already in use

Edit `.env` to use different ports or stop the conflicting service.

### Out of disk space

Docker volumes can grow large. Clean up old volumes:

```bash
docker volume prune
```

### Memory issues

Increase Docker Desktop resource limits:
- Docker Desktop Settings ‚Üí Resources
- Memory: 6GB+
- CPUs: 4+

## Development vs Production

### Development (docker compose.yml)

```bash
docker compose up -d
```

- Default credentials (for dev only!)
- No resource limits
- Logs to stdout
- Quick startup

### Production (docker compose.prod.yml)

```bash
docker compose -f docker compose.prod.yml up -d
```

- Strong passwords required
- Resource limits enforced
- Persistent volumes
- Automatic restarts
- Enhanced logging

**‚ö†Ô∏è IMPORTANT**: Change all default credentials before production deployment!

Update `.env`:
```bash
POSTGRES_PASSWORD=your-secure-password
RABBITMQ_DEFAULT_PASS=your-secure-password
MINIO_ROOT_PASSWORD=your-secure-password
REDIS_PASSWORD=your-secure-password
GRAFANA_PASSWORD=your-secure-password
```

## Next Steps (Phase 2)

After verifying all services are healthy:

1. Create core service scaffolding (FastAPI, Celery)
2. Implement service health endpoints
3. Setup service-to-infrastructure communication
4. Configure logging aggregation

See `AGENTS.md` Phase 2 section for details.

## Additional Resources

- **PostgreSQL Documentation**: https://www.postgresql.org/docs/15/
- **TimescaleDB Guide**: https://docs.timescale.com/
- **RabbitMQ Tutorials**: https://www.rabbitmq.com/getstarted.html
- **MinIO Documentation**: https://docs.min.io/
- **Redis Documentation**: https://redis.io/documentation
- **Prometheus Setup**: https://prometheus.io/docs/prometheus/latest/getting_started/
- **Grafana Guide**: https://grafana.com/docs/grafana/latest/

## Support

If infrastructure services are not starting:

1. Check Docker daemon is running: `docker ps`
2. Verify `.env` file exists and is valid
3. Check disk space: `docker volume ls`
4. Review logs: `docker compose logs`
5. Rebuild from scratch: `make clean && docker compose up -d`

---

**Phase 1 Status**: üü° IN PROGRESS  
**Last Updated**: 2025-10-22  
**Prepared By**: GitHub Copilot  
**Next Phase**: Phase 2 - Core Services Scaffolding
